from dotenv import load_dotenv
import os
import openai
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langsmith.wrappers import wrap_openai
from langsmith import traceable
from langchain_anthropic import ChatAnthropic, AnthropicLLM
from langchain.llms import OpenAI
from langchain.chains import LLMChain, SimpleSequentialChain, SequentialChain
from langchain.memory import SimpleMemory
from datetime import datetime
from langchain.callbacks.streaming_stdout import StreamingStdOutCallbackHandler
from docx import Document
from io import BytesIO

# Load environment variables
load_dotenv()

# Auto-trace LLM calls in-context
client = wrap_openai(openai.Client())

####주제 생성 프롬프트


# creating a general LLM to be used by other chains
llm1 = ChatOpenAI(temperature=0,               # 창의성 (0.0 ~ 2.0) 
                 max_tokens=2048,             # 최대 토큰수
                 model_name='gpt-4o',  # 모델명
                )
llm2 = ChatAnthropic(model='claude-3-5-sonnet-20240620', max_tokens=4096)
from langchain.output_parsers import ResponseSchema, StructuredOutputParser
from langchain.prompts import PromptTemplate
from langchain_openai import ChatOpenAI


# 사용자의 질문에 대한 답변
response_schemas = [
    ResponseSchema(name="1", description="1번째 탐구 내용"),
    ResponseSchema(name="2", description="2번째 탐구 내용"),
    ResponseSchema(name="3", description="3번째 탐구 내용"),
    ResponseSchema(name="4", description="4번째 탐구 내용"),
    ResponseSchema(name="5", description="5번째 탐구 내용"),
    ResponseSchema(name="6", description="6번째 탐구 내용"),
    ResponseSchema(name="7", description="7번째 탐구 내용"),
    ResponseSchema(name="8", description="8번째 탐구 내용"),

]

# 응답 스키마를 기반으로 한 구조화된 출력 파서 초기화
output_parser = StructuredOutputParser.from_response_schemas(response_schemas)

# 출력 형식 지시사항을 파싱합니다.
format_instructions = output_parser.get_format_instructions()
prompt_template = """
윤리에 관한 깊이 있는 고찰을 진행하고자 해. <조건>에 부합하는 윤리에 관한 서로 다른 탐구 8개를 작성해줘.
각 탐구는 서로 달라야 하며 <각 탐구에 꼭 포함되어야 할 것>을 반영해야 해.

<제공사항>
- '소재' : {소재}
- '접근방법' :
1. 소재와 관련된 논란이 발생하는 이유를 분석하고 논란을 해소하는 합리적인 방법을 제안
2. 소재와 관련해 논란이 되는 상황에서 판단의 기준을 의학 윤리와 철학의 관점에서 엄밀하게 분석하고 본인의 판단의 기준을 세우는 것
3. 소재와 관련된 국제사회에서 정치, 경제, 문화, 가치관의 차이로 인해 발생하는 갈등상황에 관한 윤리적인 고찰(이때 '관광'이라는 용어 사용하지 말아줘)
4. 일상생활에서 소재와 관련해 경험할 수 있는 사례에 대한 윤리적인 고찰
5. 소재와 관련된 지금 사회의 발전 방향, 가치의 변화로 인해 미래 사회에서 생길 수 있는 윤리적인 문제를 분석하고 의료계 종사자로서 미래 본인의 역할을 제안(인공지능 외적으로, 보편적이지 않고 소재에 가장 적합한 미래의 변화)
6. 소재와 관련된 과거와 달라진 현대사회의 사회, 문화, 시민의식, 과학기술 등을 바탕으로 과거의 사상/사상가의 관점의 한계를 지적하고, 새로운 관점에서 확장하는 방법(히포크라테스선서 외적으로, 보편적이지 않고 소재에 가장 적합한 과거 사상)
7. 소재와 관련해 논란이 있었던 실제 상황에서 쉽게 범할 수 있는 판단의 오류를 윤리적인 관점에서 분석하고, 새로운 관점의 판단 기준을 제시하는 방법
8. 소재와 관련된 동서양에서 특정 사상이 갖는 한계나 적용의 오류로 인해 벌어진 인류 역사에서의 비극과 이를 개선하기 위해 필요한 새로운 관점을 제시하는 방법(이 방법으로 탐구를 생성하기 어려우면 접근방법 1 혹은 2로 하나 더 만들어줘)


<탐구 주제의 조건>
- '소재'를 사용해야 해. '소재'와의 관련성이 논리적이어야 하나, '소재'를 그대로 사용하는 것이 아니라 적절하게 심화한 주제를 제작해줘.
- 보편적인 주제가 아닌, 서로 다른 특이적인 주제여야 해.
- 각 탐구는 '접근방법' 중 서로 다른 것을 사용해야 해.

<각 탐구에 꼭 포함되어야 할 것>
- 고찰하는 구체적인 상황이나 소재
- 어떤 이론/철학을 통해 무엇을 어떤 측면에서 분석하고 고찰하는지
- 학생이 어떤 이해/제안을 시도하는지

<추가 조건> # 탐구주제의 조건에 추가?
- 의료윤리학, 특정 사상가의 관점에서 분석이 들어가야 해. 꼭 유명하고 대표적인 사상가일 필요는 없고, 주제와 가장 맞는 사상가의 관점에서 논리적으로 분석해줘. 
- 년도와 장소가 특정되는 구체적인 사례는 넣지 말아줘.
- 원문이 외국어인 고유명사는 영어로 병기해줘.
- 의료윤리의 4원칙이 아닌, 다양한 의료윤리학 이론 중 가장 주제에 맞는 이론을 바탕으로 분석해줘.

<형식>
- '--이다'의 어체를 사용해줘.
- 당연한 말들은 작성하지 마.
- 각 탐구 내용을 작성할 때, ':'를 이용해서 주제와 구체적 내용을 구분해줘. 주제는 '윤리적 딜레마'라는 말보다 구체적으로 작성해줘.


<예시>
좋은 탐구(구체적임):
- 감염병 환자의 동선 공개와 낙인 효과: 감염병 확진자의 동선 공개가 야기하는 사회적 낙인과 차별 문제를 분석한다. John Stuart Mill의 '위해의 원칙(Harm Principle)'을 적용하여 개인의 자유와 사회적 책임 간의 균형을 모색한다. 또한 Martha Nussbaum의 '능력 접근법(Capability Approach)'을 활용해 감염병 정보 공개가 개인의 기본적 능력 발휘에 미치는 영향을 고찰한다. 이를 통해 인간 존엄성을 보장하면서도 공중보건을 지킬 수 있는 윤리적 판단 기준을 수립하고자 한다.
나쁜 탐구 1(내용이 너무 포괄적임):
- 일상적 의료 행위에서의 국제 의료 윤리 적용: 다문화 사회에서의 의사-환자 관계. 다문화 사회에서 의료인이 직면할 수 있는 문화적 차이로 인한 윤리적 갈등 상황을 분석한다. Arthur Kleinman의 설명 모델(Explanatory Model)을 활용하여, 의사와 환자 간의 문화적 차이를 이해하고 소통하는 방법을 모색한다. 이를 통해 국제 의료 봉사 경험을 일상적 의료 현장에 적용할 수 있는 윤리적 실천 방안을 제시한다.
나쁜 탐구 2(AI 기반 원격의료 시스템이 소재와 무관함.):
- AI 기반 원격의료 시스템의 발전과 저소득층 의료 접근성 향상: 미래 의료 윤리의 새로운 과제이다. 루시아노 플로리디(Luciano Floridi)의 정보 윤리학을 바탕으로, AI 의료 시스템의 발전이 가져올 윤리적 도전과 기회를 분석한다. 특히 데이터 프라이버시, 알고리즘 편향성, 의료 형평성 문제를 중심으로 미래 의료계 종사자의 윤리적 역할을 재정립하고자 한다.
나쁜 탐구 3(새로운 자원 분배 모델을 제안한다는 설명이 너무 포괄적임.):
- 공중 보건 서비스 접근성 격차의 윤리적 딜레마: 의료 자원 분배의 정의론적 접근
의료 자원의 희소성과 공중 보건 서비스 접근성 격차 문제를 존 롤스(John Rawls)의 정의론 관점에서 분석한다. '무지의 베일' 개념을 통해 의료 자원 분배의 공정성을 재고하고, 사회적 약자를 위한 차등의 원칙을 적용한 보건 정책의 윤리적 정당성을 고찰한다. 이를 바탕으로 의료 접근성 격차 해소를 위한 새로운 자원 분배 모델을 제안하고자 한다."



{format_instructions}
"""



prompt = PromptTemplate(
    template=prompt_template,
    input_variables=["소재"],
    partial_variables={"format_instructions": format_instructions},
)

chain = prompt | llm2 | output_parser  # 프롬프트, 모델, 출력 파서를 연결

####개요 생성 프롬프트

# creating a general LLM to be used by other chains
llm1 = ChatOpenAI(temperature=0,               # 창의성 (0.0 ~ 2.0) 
                 max_tokens=2048,             # 최대 토큰수
                 model_name='gpt-4o',  # 모델명
                )

llm2 = ChatAnthropic(model='claude-3-5-sonnet-20240620',max_tokens=8192)
from langchain.output_parsers import ResponseSchema, StructuredOutputParser
from langchain.prompts import PromptTemplate
from langchain_openai import ChatOpenAI

# 사용자의 질문에 대한 답변
response_schemas_0 = [
    ResponseSchema(name="양식", description="탐구계획과 어울리는 양식의 번호 ex. 양식1"),
    ResponseSchema(name="이유", description="탐구계획과 어울리는 양식의 이유"),

]
response_schemas_1 = [
    ResponseSchema(name="문제상황", description="문제상황"),
    ResponseSchema(name="윤리적_고찰", description="윤리적 고찰"),
    ResponseSchema(name="결론", description="결론"),

]
response_schemas_2 = [
    ResponseSchema(name="주제", description="주제"),
    ResponseSchema(name="1.탐구의 동기 및 필요성", description="탐구의 동기 및 필요성"),
    ResponseSchema(name="2. 문제상황", description="문제상황"),
    ResponseSchema(name="3. 윤리적 고찰", description="윤리적 고찰"),
    ResponseSchema(name="4. 결론", description="결론"),
    ResponseSchema(name="5. 느낀 점 및 후속 탐구 계획", description="느낀 점 및 후속 탐구 계획"),
    ResponseSchema(name="6. 가이드", description="가이드"),

]

# 응답 스키마를 기반으로 한 구조화된 출력 파서 초기화
output_parser_0 = StructuredOutputParser.from_response_schemas(response_schemas_0)
output_parser_1 = StructuredOutputParser.from_response_schemas(response_schemas_1)
output_parser_2 = StructuredOutputParser.from_response_schemas(response_schemas_2)

# 출력 형식 지시사항을 파싱합니다.
format_instructions_0 = output_parser_0.get_format_instructions()
format_instructions_1 = output_parser_1.get_format_instructions()
format_instructions_2 = output_parser_2.get_format_instructions()

#변경사항
#탐구 목적 제거, 굳이 본론과 싱크 안맞을 위험 넣을 필요 없음
prompt_template_v0 = """

너는 윤리에 관한 탐구 보고서를 작성하고자 하는 학생이야. 아래 탐구 계획을 보고, 가장 탐구 계획과 어울리는 보고서 양식을 골라줘. 그리고, 해당 보고서 양식이 가장 잘 어울리는 이유를 한줄로 설명해줘.



[탐구 계획] : {계획}

[양식]

   양식1. 문제 상황에 대한 쟁점들을 서로 다른 두 철학적 관점에서 해석하고, 학생의 입장을 제시하는 탐구방법
   양식2. 윤리학/철학 분야에서 기준이 모호한 문제상황을 다룰 수 있는 원칙/평가도구를 제시하고 적용하는 탐구방법
   양식3. 문제상황을 고전 윤리/철학적 관점에 입각하여 해석하고 그가 갖는 한계를 보완하여 현대적 관점에서의 해결책 제시
   양식4. 윤리/철학적 관점에서 문제상황을 분석하고, 윤리/철학적 관점에 입각하여 합리적인 해결방안 제안	

{format_instructions}
"""
prompt_양식1 = """
'문제분석'에서 제시한 쟁점을 '윤리적 고찰'에서 다뤄야 해. '1)' 'a)'을 사용해서 항목화해줘. '윤리적 고찰'은 두 step 각각에 소제목을 붙여줘.
1. 문제상황
   1) '법적/제도적 기준' : 문제상황에 관해 적용되고 있는 현재 법적/제도적 기준 2개 제시, 각각 설명
   2) '쟁점' : 충돌하는 두 개의 가치(윤리적 딜레마) 3개 제시, 각각 설명
2. 윤리적 고찰
   1) 윤리학/철학 분야 관점를 설명, 해당 관점에서 '쟁점'의 가치 중 어떤 가치에 더 비중을 두는지 각각 분석, 한계점 설명
   2) 1)과 상반되는 해석을 제공하는 다른 윤리학/철학 분야 관점을 설명, 해당 관점에서 '쟁점'의 가치 중 어떤 가치에 더 비중을 두는지 각각 분석, 한계범 설명
3. 결론 : 두 가지 서로 다른 결론을 제시할거야.  
   1) 결론 A : 윤리적 고찰 STEP1의 관점에서 내릴 수 있는 결론과, 한계에 대한 방어/보완
   2) 결론 B : 윤리적 고찰 STEP2의 관점에서 내릴 수 있는 결론과, 한계에 대한 방어/보완

"""
prompt_양식2 = """
'문제분석'에서 제시한 쟁점을 '윤리적 고찰'에서 다뤄야 해. '윤리적 고찰'은 두 step 각각에 소제목을 붙여줘.
1. 문제상황
   1) '법적/제도적 기준' : 문제상황에 관해 적용되고 있는 현재 법적/제도적 기준 2개 제시, 각각 설명
   2) '쟁점' : 판단의 기준이 모호한 상황 3개 제시, 각각 설명
2. 윤리적 고찰
   1) 윤리학/철학 분야에서 기준이 모호한 문제상황을 다룰 수 있는 원칙/평가도구 1개를 설명, 문제상황에 적용, 한계점 설명
   2) 1) 에서 다룬 원칙/평가도구를 적용한 구체적인 판단 기준 체계적으로 제시
3. 결론  
   1) '윤리적 고찰'의 내용을 요약 및 의의 강조
   2) 제시한 판단 기준의 한계를 해결할 수 있는 창의적인 방법, 학생의 생각 제시
   
"""   

prompt_양식3 = """
'문제분석'에서 제시한 문제상황을 '윤리적 고찰'에서 다뤄야 해. '윤리적 고찰'은 두 step 각각에 소제목을 붙여줘.
1. 문제상황
   1) '법적/제도적 기준' : 문제상황에 관해 적용되고 있는 현재 법적/제도적 기준 2개 제시, 각각 설명
   2) '문제분석' : 현재의 해당 주제와 관련하여 야기되는 문제상황 3개와 각 문제상황에서 침해되는 가치 설명
2. 윤리적 고찰
   1) 고전 윤리/철학적 관점에 입각한 해석과 그가 갖는 한계점
   2) 1)의 한계를 보완한, 혹은 1)에서 고려하지 못하는 것(ex. 생체정보의 특수성)을 고려한 현대적 관점에서의 재해석/해결책/보완책
3. 결론  
   1) '윤리적 고찰'의 내용을 요약 및 의의 강조
   2) 제시한 현대적 관점에서도 해결되지 못한 한계, 미래 의료인으로서 학생이 해결하고자 하는 방안
"""

prompt_양식4 = """
'문제분석'에서 제시한 쟁점을 '윤리적 고찰'에서 다뤄야 해. '윤리적 고찰'은 두 step 각각에 소제목을 붙여줘.
1. 문제상황
   1) '법적/제도적 기준' : 문제상황에 관해 적용되고 있는 현재 법적/제도적 기준
   2) '문제분석' : 현재의 해당 주제와 관련하여 야기되는 문제상황 3개와 각 문제상황에서 침해되는 가치 나열
2. 윤리적 고찰
   1) 윤리/철학적 관점에서 문제상황에서 다루는 개념에 대한 정의, 현상에 대한 설명
   2) 윤리/철학적 관점에 입각하여 합리적인 해결방안 제안	
3. 결론 :
   1) '윤리적 고찰'의 내용을 요약 및 의의 강조
   2) 제시한 해결방안에서도 해결되지 못한 한계, 미래 의료인으로서 학생이 해결하고자 하는 방안
"""

prompt_template_v1 = """

제공된 '탐구 계획'을 개선하여, 의료 윤리에 관한 깊이 있는 탐구 보고서를 작성하고자 해.
아래 [탐구 계획]을 바탕으로 [가이드라인]에 맞추어 숨을 크게 들이마시고 문제상황, 윤리적 고찰, 결론의 내용을 작성해줘. 문제상황, 윤리적 고찰, 결론이 항목은 체계적으로 구분되게, 내용은 유기적으로 연결되게 작성해줘.
이때 [조건]과 [주의사항]을 고려해줘.
계획에서 ':'앞에 있는 내용이 주제이며, 주제는 바꾸지 마.

[탐구 계획]
{계획}

[가이드라인]
{가이드라인}

[조건]
1. 학생의 사고력과, 의학적 의의가 드러나야 해.
2. '--입니다'가 아닌 formal한 어체 써줘.
3. 충분히 구체적이고 자세하게 써줘.

[주의사항]
1. 서로 상충하는 두 가치에 대해, 모호한 해석을 않도록 주의해. 특정 이론에 근거해서 A와 B 중 한 가치에 더 비중을 두고, 예외적인 상황을 설명하는 등 논지를 명확하게 해줘.
   bad example 1 : A면서도 B이다 (X)
   bad example 2 : A와 B의 균형점을 찾아야 한다 (X)

2. 실제 있는 내용만 명시되어야 하며(특히 법/제도), hallucination의 위험이 있는 구체적인 날짜/수치는 명시하지 마.

3. 다루는 내용의 범위가 너무 많기보다, 핵심적인 2 step의 윤리적 고찰로 정리될 수 있을만큼 간결하고 명확해야 해. '윤리적 고찰'의 두 step 각각에 소제목을 붙여줘.

4. 내용이 구체적이어야 해.
   bad example 1 : '미국, 영국, 일본, 한국의 법적, 윤리적 접근 비교'
   bad example 1의 개선 방안 : 구체적으로 세 나라가 어떻게 다른지에 대한 설명이 있어야 함.
   
5. 아래 방법은 고등학생이 하기에 어려우므로, 포함하지 말아줘.
   1) 실제 환자 / 의료진을 대상으로 한 인터뷰나 설문조사
   2) 실제 사례 통계 분석
   3) 방대한 데이터베이스를 바탕으로 한 문헌 연구
   
6. 영단어, 사람 이름의 경우 한국어(영어)로 한국어와 영어를 병기해줘.
   good example 1 : 노멀 다니엘스(Norman Daniels), 피터 싱어(Peter Singer)
   
{format_instructions}

"""



prompt_template_v2 = """
의료 윤리에 관한 깊이 있는 고찰을 진행하고자 해. [제공사항]에서 제공된 탐구 내용을 바탕으로, [메뉴얼]대로 필요한 내용을 추가 및 보완하여 최종 탐구 보고서를 작성해줘. 
계획에서 ':'앞에 있는 내용이 주제이며, 주제는 바꾸지 마.

숨을 깊게 들이마시고, 차근차근 작성해줘. 


[제공사항]
   계획 : {계획}
   문제 상황 : {문제상황}
   윤리적 고찰 : {윤리적_고찰}
   결론 : {결론}



[메뉴얼]

   1. 탐구의 동기 및 필요성 
      1)탐구의 동기
         a) 분량 : 2개 문단으로 제시
         b) 내용 : 고등학생이 해당 문제에 호기심을 갖게 된 계기(ex.---한 경험/을 통해, 호기심을 갖게 되었다.), 배경(ex.최근 --이 주목받고 있다, 사회적 관심이 높아지고 있다. 등 제시
         c) 조건 : 
            (1) 구체적인 날짜, 사람, 수치는 포함하지 않아야 함.
            (2) 호기심을 가질 수 있을만한, 출처 표기가 필요 없는 경험 기반의 계기여야 함. 호기심을 갖게 된 학생의 사고가 구체적이고 논리적으로 드러나야 함.
            (3) 만약 영화/책/드라마 등을 넣는다면, 구체적인 제목을 특정해서 넣지 말고 존재할만한 내용을 구체적으로 담아야 함. 학생이 찾을 수 있는, 있을 만한(혹은 있는) 영화/책/드라마여야 함.
         d) 예시
            (1) 최근 지속되는 폭염으로 인해 도시 열섬 현상이 심화되면서, 특히 저소득 지역에서 더 큰 피해가 발생하고 있다는 뉴스를 접하게 되었다. 이를 통해 기후 변화가 모든 사람에게 동일한 영향을 미치는 것이 아니라, 사회경제적 지위에 따라 그 영향이 다르게 나타날 수 있다는 점에 주목하게 되었다. 특히 노인 복지관에서 봉사활동을 하면서 만난 독거노인들이 여름철 냉방기기 사용에 어려움을 겪는 모습을 보며, 기후 변화가 취약 계층의 건강에 미치는 불균형적인 영향에 대해 깊이 고민하게 되었다.
            (2) 최근 과학 다큐멘터리를 통해 CRISPR-Cas9 유전자 편집 기술의 발전과 그에 따른 윤리적 논란을 접하게 되었다. 특히 의학 연구를 위한 유전자 편집 동물 모델 개발이 가져올 수 있는 잠재적 이익과 위험에 대해 깊은 관심을 갖게 되었다. 이러한 기술이 인간의 질병 치료에 혁명적인 진전을 가져올 수 있다는 점에서 흥미로웠지만, 동시에 생명 조작에 대한 윤리적 우려도 제기되었다. 특히 한스 요나스(Hans Jonas)의 '책임의 원칙(The Imperative of Responsibility)'에 대해 알게 되면서, 현세대가 미래 세대와 생태계에 대해 져야 할 윤리적 책임에 대해 고민하게 되었다.
            (3) 의료기술의 발전으로 새로운 치료법이 계속해서 개발되고 있지만, 동시에 그 비용도 증가하고 있다. 이러한 상황에서 효율성과 공정성을 어떻게 조화시킬 수 있을지 고민하게 되었다. 특히 공리주의적 접근이 가진 장단점에 대해 깊이 있게 탐구하고 싶었다. 더불어 최근 읽은 의료윤리 관련 서적에서 접한 '선호 공리주의' 개념이 이러한 딜레마를 해결하는 데 도움이 될 수 있을지 궁금증이 생겼다.
      
      2) 탐구의 필요성
         a) 분량 : 세 가지 필요성 제시, 첫째/둘째/셋째라는 표현 써줘. 구체적이고 논리적으로 써줘.
         b) 조건 : 이 탐구가 필요한 이유, 기여 방안이 논리적, 구체적으로 작성되어야 함. 구체적인 날짜, 사람, 수치는 포함하지 않아야 함.


   2. 문제상황은 아래와 같이 작성해줘. 
      1) 법적/제도적 기준 : 문제 상황에 대한 법적/제도적 기준 2가지 구체적으로 제시
      2) '쟁점' 혹은 '문제분석' 중 [제공사항]에서 쓰인 단어로 소제목을 붙여줘. [제공사항]에 충실하게 3가지 구체적으로 제시, 구체적으로 사례를 들어 작성해줘.
   3. '윤리적 고찰'은 1), 2) 번호매김하여 구체적으로 작성해줘. 각 번호마다 소제목을 붙여줘.
      1) 내용 : [제공사항]의 내용을 구체화해줘.한 번호에 한 이론만 담아줘. 
      2) 조건 :
         a) 논리적인 정합성과 유기성을 고려해서 작성해줘. '윤리적 고찰'은 보고서의 핵심이야.
         b) 너무 방대한 내용을 담기보다, 구체적으로 작성해줘.
         c) 문제상황과 연결지어서 작성해줘.
   4. 결론
      1) 내용 : [제공사항]의 내용을 구체화해줘. 3개 문단으로 작성해줘. 논리적으로 완결성을 갖춘 결론이어야 해.
      2) 조건 : 일반적인 내용에 한정하지 말고 해당 주제에 특이적이고 구체적인 내용을 제시해줘. 본론 내용을 바탕으로 학생이 내릴 수 있는 가치판단과, 추가적으로 학생의 사고력이 드러나는 생각과 논리적인 근거를 꼭 포함하여 작성해줘. 
      3) 주의사항 : 서로 상충하는 두 가치에 대해, A면서도 B이다 혹은 A와 B의 균형점을 찾아야 한다 등 모호한 해석을 않도록 주의해. 특정 이론에 근거해서 A와 B 중 한 가치에 더 비중을 두고, 예외적인 상황을 설명하는 등 논지를 명확하게 해줘
      
   5. 느낀 점 및 후속 탐구 계획
      1) 느낀 점 : 탐구를 통해 느낀 점, 아쉬운 점, 미래 의료인으로서 다짐 등을 한문단으로 작성해줘.
      2) 후속 탐구 계획 : 후속 탐구를 통한 보완 가능성을 제시해줘. 고등학생 수준에서, 다음 탐구 주제로 삼을 수 있는 현실적인 이론적 탐구에 한정해서 제시해줘. 이때, '실제 의료 현장에서의 적용 가능성'에 관한 한계는 언급하지 말아줘.
         example.
         a) 본 연구는, --에서 부족했다는 한계가 있다.
         b) 다음과 같은 후속 탐구를 통하여, 보완이 가능할 것이다:
         
   6. 가이드 : 아래 내용을 추가로 제시해줄거야. 
      1) 고찰의 동기는 학생에게 맞는 고찰의 동기로 바꿀 수 있음을 제시할거야. 이때, 검색어는 고찰에 관한 시사적 내용이나 문헌을 찾을 수 있는 검색어 5개를 추천해줘 .
      
         #출력 양식
         '고찰의 동기'는 예시로 작성되었으며, 다음과 같은 검색어를 통해 해당 고찰에 관련된 책, 정책, 기사 등을 찾아보고 학생의 상황에 맞는 '고찰의 동기'를 작성하는 것을 권장합니다.
            검색어 : 
            1)...
            
         
      2) 4명의 학생 각각 성향에 맞게 탐구 내용을 바탕으로 학생이 내릴 수 있는 가치판단과, 추가적으로 학생의 사고력이 드러나는 특이적인 생각을 한문단으로 작성해줘. 보편적인 생각보다는, 학생의 특별함이 드러나야 해. 학생의 생각에는 근거와 예시가 각각 1개 이상 있어야 해.
         a) 학생 A: 이성적 공리주의자
            성향: 학생 A는 논리적 사고와 이성에 기반하여 윤리적 문제를 해결하려고 합니다. 감정적 접근보다는 과학적이고 정량적인 방법을 선호하며, 문제를 최대한 객관적으로 분석하려 합니다. 윤리적 딜레마에서는 답을 찾으려고 노력하며, 특히 공리주의와 같이 최대 다수의 최대 행복을 추구하는 원칙에 끌립니다. 감정이 배제된 현실적인 조언을 주로 하며, 이로 인해 때로는 타인의 감정을 충분히 고려하지 못할 때도 있습니다.
         b) 학생 B: 감성적 공감주의자
            성향: 학생 B는 타인의 감정과 상황에 깊이 공감하며, 윤리적 판단에서 감정적 요소를 중시합니다. 윤리적 문제를 해결할 때는 사람들의 감정적 반응과 그들의 경험을 중요하게 생각하며, 상황에 맞는 따뜻한 조언을 하려고 합니다. 도덕적 판단에 있어 상황 윤리나 관계 윤리를 선호하며, 모든 상황이 다르기 때문에 고정된 윤리적 규칙보다는 맥락에 따라 유연하게 판단하려 합니다.
         c) 학생 C: 경험적 현실주의자
            성향: 학생 C는 이성과 감성을 균형 있게 고려하려 하며, 자신의 경험에 기반하여 윤리적 문제를 판단합니다. 실제 상황에서의 결과를 중요시하며, 이상적인 해결책보다는 현실적인 접근을 선호합니다. 윤리적 문제를 해결할 때는 실용적인 측면을 중시하며, 특히 의료윤리와 같이 현실적이고 복잡한 상황에서는 경험에 기반한 판단을 내립니다. 타인의 경험과 사회적 영향까지 고려하는 실용주의적 태도를 지니고 있습니다.
         d) 학생 D: 이상적 윤리주의자
            성향: 학생 D는 윤리적 문제에 대해 철학적이고 이상적인 접근을 추구합니다. 고정된 도덕적 원칙을 중요하게 생각하며, 이성과 감정을 모두 고려하면서도 윤리적 원칙을 따르려고 합니다. 예를 들어, 의료윤리에서 환자의 자율성이나 인간의 존엄성 같은 중요한 윤리적 가치를 우선시하며, 현실의 제약이 있더라도 이상적인 해결책을 찾으려 합니다. 타협보다는 원칙을 중시하는 경향이 있으며, 윤리적 딜레마에서 도덕적 원칙을 적용하려는 노력을 기울입니다.
               
         
         #출력 양식
         다음 내용은 서로 다른 4가지 성향을 가진 학생이 각각 본 보고서를 바탕으로 추가적으로 할 수 있는 생각입니다. 참고하여 결론을 보완하세요.
            a) 학생 A: 이성적 공리주의자 - 학생 A는 논리적 사고와 이성에 기반하여 윤리적 문제를 해결하려고 합니다. 
               생각 : 
            b) 학생 B: 감성적 공감주의자 - 학생 B는 타인의 감정과 상황에 깊이 공감하며, 윤리적 판단에서 감정적 요소를 중시합니다.
               생각 : 
            c) 학생 C: 경험적 현실주의자 - 학생 C는 이성과 감성을 균형 있게 고려하려 하며, 자신의 경험에 기반하여 윤리적 문제를 판단합니다.
               생각 : 
            d) 학생 D: 이상적 윤리주의자 - 학생 D는 윤리적 문제에 대해 철학적이고 이상적인 접근을 추구합니다. 
               생각 : 


[조건]

   1. 아주 구체적이어야 해. 내용이 얕고 방대해지지 않게 주의해줘.
      example 1. ‘유전자 개선의 윤리적 한계 분석’ => '유전자 개선의 윤리적인 한계인 A, B 분석. A의 관점에서는~ B의 관점에서는~'
      example 2. 'A에 대한 철학적 고찰' => 'A가 a1, a2의 관점에서 이러이러한 것임을 고찰'
      example 3. 'A의 개념 분석' => 'A의 개념인 a, b를 설명'
      example 4. '관련 조항 분석' => '관련 조항에는 A, B가 있음. A는~, B는~'
   2. 학생의 사고력이 드러나야 해.
   3. 의학과 관련된 의의가 드러나야 해.
   4. 8192 토큰 안에 누락되는 내용 없이 모든 내용을 골고루 담아줘. 내용이 잘리지 않게 해줘.
   5. 전반적인 보고서 내용의 전개가 논리적이어야 함.
   6. 성의 있고 구체적으로 작성해야 함.   
   7. 외국어일 경우,영어 단어, 사람 이름의 경우 한국어(영어)로 한국어와 영어를 병기해줘.
      example 1. 임마누엘 칸트(Immanuel Kant), 톰 뷰참프(Tom Beauchamp)
   8. 모든 조건을 누락하지 말고 차근차근 고려해서 보고서를 만들어줘.
   9. 추가적인 말 없이 오직 [답변양식]에 속하는 내용만 출력해줘.
   10. 한국어와 영어 외에 다른 언어는 사용하지 말아줘.
   
[주의사항]
   1. [예시]를 참고해서, 예시의 좋은 점을 반영하고, 안좋은 점은 그런 내용을 담지 않도록 주의해줘.
   2. 해당 탐구도, 후속 탐구도 고등학생 수준에서 할 수 있어야 하므로 아래 내용은 보고서 전체에 언급하지 말아줘. 
      1) 실제 환자 / 의료진을 대상으로 한 인터뷰나 설문조사
      2) 실제 사례 통계 분석
      3) 방대한 데이터베이스를 바탕으로 한 문헌 연구
   3.학생과 어울리지 않는 단어는 지양해줘. '--입니다.'의 어체는 쓰지 말고 formal한 어체 써줘.
      1) '프레임워크 개발' => '접근방법 제안'
      2) '인터페이스, 에플리케이션 개발'은 학생 수준에서 하기 어려운 내용이니, 적절한 대체재로 작성해줘
      3) '의료 관광' 등, '관광'이라는 표현을 사용하지 말아줘. 한국어로 어색한 표현이야.
   4. [답변양식]과 번호표기가 일치하도록 유의해줘. 예를 들어, '1. 탐구의 동기'는 틀린 표현이며, '1) 탐구의 동기'가 맞는 표현이야.

[예시]
      
   example 1. 
      a)  정신의학과 사회 통제의 관계에 대한 철학적 고찰
         - 미셸 푸코(Michel Foucault)의 '규율 권력' 개념 적용
         - 마사 누스바움(Martha Nussbaum)의 역량 접근법 분석
         - 피터 싱어(Peter Singer)의 공리주의적 관점 검토
   example 1이 좋은 이유 : 
      1) 철학자와 구체적인 관점/개념 이름이 명시됨
   example 1이 안좋은 이유 : 
      1) 각 내용이 구체적으로 어떻게 정신의학과 사회통제의 관계와 연결되는지 설명되어 있지 않음. 관점/개념에 대한 구체적인 설명이 필요함.
      2) 너무 많은 운리/철학적 개념을 씀.
      3) 너무 많은 내용이 간략하게 포함되어 있어서, 보고서의 깊이가 없음.
      

   example 2. 
      '무지의 베일' 개념을 활용한 의료 과실 보상 체계 설계
         - 당사자들이 자신의 입장(의료인 또는 환자)을 모르는 상태에서 보상 체계를 설계한다면?
         - 이를 통해 공정성과 형평성 확보 가능성 탐구
   example 2가 안좋은 이유 :  
      1) 구체적인 내용이 나와 있지 않고 형식적으로 불친절함.
      2) 물음표로 끝맺지 말고, 당사자들이 자신의 입장(의료인 또는 환자)을 모르는 상태에서 보상 체계를 설계한다면, --할 것이다. 따라서 --하다. 의 형식으로 구체적으로 작성

   example 3.
      원칙들 간의 충돌 해결 방안
         - 사례별 맥락을 고려한 유연한 적용: 각 원칙의 중요도를 상황에 맞게 조정
         - 다학제적 윤리위원회 구성: 다양한 관점을 반영한 의사결정 과정 도입
   example 3이 안좋은 이유 :  
      1) 구체적인 내용이 나와 있지 않고 성의없음.
      2) 사례별 맥락에 대한 구체적인 예시를 적을 필요가 있음.

   

[답변 양식]
   주제 : 
   1. 탐구의 동기 및 필요성
      1) 탐구의 동기
      2) 탐구의 필요성
   2. 문제 상황
      1) 
         a)
         b)
      2) 
         a)
         b)
         c)
   3. 윤리적 고찰
      1)
         a)...
      2)
         a)...
   4. 결론
   5. 느낀 점 및 후속 탐구 계획
      1) 느낀 점
      2) 후속 탐구 계획
   6. 가이드
"""
prompt0 = PromptTemplate(
    template=prompt_template_v0,
    input_variables=["계획"],
    partial_variables = {"format_instructions" : format_instructions_0},
)

prompt1 = PromptTemplate(
    template=prompt_template_v1,
    input_variables=["계획", "가이드라인"],
   partial_variables={"format_instructions": format_instructions_1},
)
prompt2 = PromptTemplate(
    template=prompt_template_v2,
    input_variables=["계획", "문제상황", "윤리적_고찰", "결론"],
)

chain_0 = prompt0 | llm2 | output_parser_0
chain_1 = prompt1 | llm2 | output_parser_1
chain_2 = prompt2 | llm2 | StrOutputParser()  # 프롬프트, 모델, 출력 파서를 연결


####함수 정의

def generate_plans(소재):
    input_data = {"소재": 소재}
    result = chain.invoke(input_data)
    return result

def manual(계획) :
    input_data = {"계획" : 계획}
    result = chain_0.invoke(input_data)
    return result

def init_plan(계획, 가이드라인):
    input_data = {"계획": 계획, "가이드라인" : 가이드라인}
    result = chain_1.invoke(input_data)
    return result

def final_plan(계획, 문제상황, 윤리적_고찰, 결론):
    input_data = {"계획": 계획, "문제상황" : 문제상황, "윤리적_고찰" : 윤리적_고찰, "결론" : 결론}
    result = chain_2.invoke(input_data)
    return result

def make_report(계획) :
    result1=manual(계획)
    양식 = prompt_양식1 if result1['양식'] == '양식1' else prompt_양식2 if result1['양식'] == '양식2' else prompt_양식3 if result1['양식'] == '양식3' else prompt_양식4 if result1['양식'] == '양식4' else None
    result2=init_plan(계획, 양식)
    result3=final_plan(계획, result2['문제상황'], result2['윤리적_고찰'], result2['결론'])
    return result3
 
 
# 워드 파일 생성 함수
def create_word_file(code):
    doc = Document()
    doc.add_heading('윤리 보고서', 0)  # 제목 추가
    doc.add_paragraph(code)  # 코드 내용을 워드 문서에 추가

    # BytesIO를 사용하여 메모리에 파일 저장
    file_stream = BytesIO()
    doc.save(file_stream)
    file_stream.seek(0)  # 파일 포인터를 처음으로 이동
    return file_stream